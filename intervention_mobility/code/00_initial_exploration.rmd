---
title: "Government Intervention and Mobility Trend"
author: "Kenneth Lee"
date: "10/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```
## Mobility and Cases Data Exploration

In this notebook, we will explore the mobility data from Safegraph via [Delphi Epidata API](https://cmu-delphi.github.io/delphi-epidata/api/covidcast_signals.html). 


```{r import packages, warning = FALSE, message = FALSE}
library(ggplot2)
library (readr)
library(tidyverse)
library(dplyr)
library(covidcast)
library(lubridate)
library(ggpubr)
```

```{r define global variables}
STARTDATE <- "2020-02-20"
ENDDATE <- date(Sys.time())
GEO_TYPE = "state" # state-level
GEO_VALUE = "*" # all states
EXCLUDED_AREAS = c("as","gu", "mp","vi") # excluded areas due to small sample size
DT_X = 7 # 	 Time shifts to consider for x
```


```{r import data, warning = FALSE, message=FALSE}
# The fraction of mobile devices that spent more than 6 hours at a 
# location other than their home during the daytime 
# (SafeGraphâ€™s full_time_work_behavior_devices / device_count)
ftime <- covidcast_signal(data_source = "safegraph", 
                          signal ="full_time_work_prop",
                          start_day = STARTDATE, 
                          end_day = ENDDATE,
                          geo_type = GEO_TYPE, 
                          geo_values = GEO_VALUE)

ftime <- ftime %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

############## New confirmed COVID19 cases ############

# A composite signal from JHU and USA facts
# New confirmed COVID19 cases on average per 7 days
case_avg <- covidcast_signal(data_source = "indicator-combination",
                         signal ="confirmed_7dav_incidence_num",
                         start_day = STARTDATE, 
                         end_day = ENDDATE,
                         geo_type = GEO_TYPE, 
                         geo_values = GEO_VALUE)

case_avg <- case_avg %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

# Cumulative confirmed COVID19 cases on average per 7 days
#cum_case <- covidcast_signal(data_source = "indicator-combination",
#                         signal ="confirmed_7dav_cumulative_num	",
#                         start_day = STARTDATE, 
#                         end_day = ENDDATE,
#                         geo_type = GEO_TYPE, 
#                         geo_values = GEO_VALUE)

#cum_case <- cum_case %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

# Cumulative confirmed COVID19 cases on average per 7 days, per 100,000 population

#cum_case_prop <- covidcast_signal(data_source = "indicator-combination",
#                         signal ="confirmed_7dav_cumulative_prop	",
#                         start_day = STARTDATE, #
#                         end_day = ENDDATE,
#                         geo_type = GEO_TYPE, 
#                         geo_values = GEO_VALUE)

#cum_case_prop <- cum_case_prop %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

########### Death cases ######################

# Number of new confirmed deaths due to COVID-19, daily
death_case <- covidcast_signal(data_source = "indicator-combination",
                         signal ="deaths_7dav_incidence_num",
                         start_day = STARTDATE, 
                         end_day = ENDDATE,
                         geo_type = GEO_TYPE, 
                         geo_values = GEO_VALUE)

death_case <- death_case %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

# Cumulative number of confirmed deaths due to COVID-19
cum_death_case <- covidcast_signal(data_source = "indicator-combination",
                         signal ="deaths_7dav_cumulative_num",
                         start_day = STARTDATE, 
                         end_day = ENDDATE,
                         geo_type = GEO_TYPE, 
                         geo_values = GEO_VALUE)
cum_death_case  <- cum_death_case  %>%  filter(!(geo_value %in% EXCLUDED_AREAS))

```

```{r full-time signal line plot}
p <- ggplot(ftime, aes(x=time_value, y=value)) +
  geom_line(aes(color = geo_value)) + 
  labs(title = "Full-time away home signal", y= "The fraction of mobile devices that spent more than 6 hours other than home")
p
```

## Correlation between cases and mobility signal

We might be intersted in knowing how cases now correlate with mobility signal in the future. Using the $dt_x$ parameter, we can shift the signal by 7 days forward in time, before calculating correlations. 

```{r peasrson correlation by time}
cor1 <- covidcast_cor(case_avg, ftime, by = "time_value")
cor2 <- covidcast_cor(case_avg, ftime,  by = "time_value", dt_x = DT_X)
cor3 <- covidcast_cor(case_avg, ftime,  by = "time_value", dt_x = 10)


# Stack rowwise into one data frame, then plot time series
all_cor <- rbind(cor1, cor2, cor3)
# Add labels
all_cor$Shift <- as.factor(c(rep(0, nrow(cor1)), rep(DT_X, nrow(cor2)), rep(14, nrow(cor3))))

# Plot the graph
signal_name = "full-time away home"
p <- ggplot(all_cor, aes(x = time_value, y = value)) +
  geom_line(aes(color = Shift)) +
  labs(title = sprintf("Pearson Correlation between %s and cases", signal_name),
       subtitle = "Average per 7 days, over states",
       x = "Date", y = "Correlation") 
p
```
### Spearman correlation

```{r spearman correlation by time}
scor1 <- covidcast_cor(case_avg, ftime, by = "time_value",  method = "spearman")
scor2 <- covidcast_cor(case_avg, ftime,  by = "time_value", dt_x = DT_X,  method = "spearman")
scor3 <- covidcast_cor(case_avg, ftime,  by = "time_value", dt_x = 10,  method = "spearman")

# Stack rowwise into one data frame, then plot time series
all_scor <- rbind(scor1, scor2, scor3)
# Add labels
all_scor$Shift <- as.factor(c(rep(0, nrow(scor1)), rep(DT_X, nrow(scor2)), rep(10, nrow(scor3))))

# Plot the graph
signal_name = "full-time away home"
p <- ggplot(all_scor, aes(x = time_value, y = value)) +
  geom_line(aes(color = Shift)) +
  labs(title = sprintf("Spearman Correlation between %s and cases", signal_name),
       subtitle = "Average per 7 days, over states",
       x = "Date", y = "Correlation") 
p
```

### Correlation in space

```{r pearson correlation plot in space}
# Set a bunch of fields so that the data frame knows how to plot itself
cor3_by_geo <- covidcast_cor(case_avg, ftime,  by = "geo_value", dt_x = 10)

cor3_by_geo$time_value = STARTDATE
cor3_by_geo$issue = STARTDATE
attributes(cor3_by_geo)$geo_type = "state"
class(cor3_by_geo) = c("covidcast_signal", "data.frame")

# Plot choropleth maps, using the covidcast plotting functionality
plot(cor3_by_geo, title = "Correlations between 10-day shifted cases and mobility signal",
     range = c(-1, 1), choro_col = c("orange","lightblue", "purple"))
```

### What lag one signal is most correlated with the other?

```{r lag analysis}
# A function to compute the corrlation by various number of shifts
getCorrByShift <- function(num_shift, signal_1, signal_2, corr_method, typename){
   dt_vec <- 0:num_shift
df_list <- vector("list", length(dt_vec))
for (i in 1:length(dt_vec)) {
  df_list[[i]] <- covidcast_cor(signal_1, signal_2, dt_x = dt_vec[i],by = "geo_value", method= corr_method)
  df_list[[i]]$dt <- dt_vec[i]
}
df <- do.call(rbind, df_list)
return(df)
}

# A function to derive median of the signal from each shift 
getMedian <-function(df){
  df_med <- df %>%
  group_by(dt) %>%
  summarize(median = median(value, na.rm = TRUE), .groups = "drop_last")
  return(df_med)
}

# Compute pearson correlation between new confirmed cases and mobility
df_p_case <- getCorrByShift(100, case_avg, ftime, "pearson")
df_pcase_med <- getMedian(df_p_case)
df_pcase_med$Comparison <- "confirmed case"

# Compute pearson correlation between death cases and mobility
df_p_death <- getCorrByShift(100, death_case,ftime, "pearson")
df_pdeath_med <-  getMedian(df_p_death)
df_pdeath_med$Comparison <- "death case"

# pearson correlation between cum_death cases and mobility

df_cump_death <- getCorrByShift(100, cum_death_case,ftime, "pearson")

df_cum_death_med <-  getMedian(df_cump_death)
df_cum_death_med$Comparison <- "cumulative death case"

# Stack two dataframe row-wise
df_all_signals <- rbind(df_pcase_med, df_pdeath_med, df_cum_death_med)

# plot the graph
ggplot(df_all_signals, aes(x = dt, y = median)) + geom_line(aes(color = Comparison)) + geom_point(aes(color = Comparison)) +
  labs(title = "Median Pearson correlation between mobility and other signals",
       x = "Shift", y = "Correlation") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

### Let's change to a different correlation method.

```{r spearman lag analysis}
# Compute spearman correlation between new confirmed cases and mobility
df_p_case <- getCorrByShift(100, case_avg, ftime, "spearman")
df_pcase_med <- getMedian(df_p_case)
df_pcase_med$Comparison <- "confirmed case"

# Compute spearman correlation between death cases and mobility
df_p_death <- getCorrByShift(100, death_case,ftime, "spearman")
df_pdeath_med <-  getMedian(df_p_death)
df_pdeath_med$Comparison <- "death case"

# Compute spearman correlation between cum death cases and mobility
df_cump_death <- getCorrByShift(100, cum_death_case,ftime, "spearman")
df_cum_death_med <-  getMedian(df_cump_death)
df_cum_death_med$Comparison <- "cumulative death case"

# Stack two dataframe row-wise
df_all_signals <- rbind(df_pcase_med, df_pdeath_med, df_cum_death_med)

# plot the graph
ggplot(df_all_signals, aes(x = dt, y = median)) + geom_line(aes(color = Comparison)) + geom_point(aes(color = Comparison)) +
  labs(title = "Median Spearman correlation between mobility and other signals",
       x = "Shift", y = "Correlation") +
  theme(legend.position = "bottom", legend.title = element_blank())
```



