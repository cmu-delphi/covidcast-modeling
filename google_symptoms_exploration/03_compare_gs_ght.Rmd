---
title: "Google Symptoms anosmia + ageusia indicator vs GHT indicator"
author: "Nat"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, cache = TRUE, warning = FALSE)
```


```{r import_statements, echo = FALSE, message = FALSE}
library(tidyverse)
library(covidcast)
library(dplyr)
library(ggplot2)
```

```{r declare_global_constants}
POSTAL_TO_STATE = list('AL'='Alabama', 'AK'='Alaska', 'AS'='American Samoa',
                       'AZ'='Arizona', 'AR'='Arkansas', 'CA'='California',
                       'CO'='Colorado', 'CT'='Connecticut', 'DE'='Delaware',
                       'DC'='District of Columbia', 'FL'='Florida',
                       'GA'='Georgia', 'GU'='Guam', 'HI'='Hawaii',
                       'ID'='Idaho', 'IL'='Illinois', 'IN'='Indiana',
                       'IA'='Iowa', 'KS'='Kansas', 'KY'='Kentucky',
                       'LA'='Louisiana', 'ME'='Maine', 'MD'='Maryland',
                       'MA'='Massachusetts', 'MI'='Michigan', 'MN'='Minnesota',
                       'MS'='Mississippi', 'MO'='Missouri', 'MT'='Montana',
                       'NE'='Nebraska', 'NV'='Nevada', 'NH'='New Hampshire',
                       'NJ'='New Jersey', 'NM'='New Mexico', 'NY'='New York',
                       'NC'='North Carolina', 'ND'='North Dakota',
                       'MP'='Northern Mariana Islands', 'OH'='Ohio',
                       'OK'='Oklahoma', 'OR'='Oregon', 'PA'='Pennsylvania',
                       'PR'='Puerto Rico', 'RI'='Rhode Island', 'SC'='South Carolina',
                       'SD'='South Dakota', 'TN'='Tennessee',
                       'TX'='Texas', 'UT'='Utah', 'VT'='Vermont', 'VI'='Virgin Islands',
                       'VA'='Virginia', 'WA'='Washington', 'WV'='West Virginia',
                       'WI'='Wisconsin', 'WY'='Wyoming')

states = c("al", "ak", "az", "ar", "ca", "co", "ct", "de", "fl", "ga", "hi",
           "id", "il", "in", "ia", "ks", "ky", "la", "me", "md", "ma", "mi",
           "mn", "ms", "mo", "mt", "ne", "nv", "nh", "nj", "nm", "ny", "nc",
           "nd", "oh", "ok", "or", "pa", "ri", "sc", "sd", "tn", "tx", "ut",
           "vt", "va", "wa", "wv", "wi", "wy")

BASE_DAILY_URL = paste0(
      'https://raw.githubusercontent.com/google-research/open-covid-19-data/',
      'master/data/exports/search_trends_symptoms_dataset/',
      'United%20States%20of%20America/subregions/{state}/',
      '2020_US_{state_underscore}_daily_symptoms_dataset.csv')
cache_data_list = list()
signal_description_df = tribble(
    ~signal,            ~description,
    'Podalgia',                         'pain in the foot',
    'Anosmia',                          'loss of smell',
    'Purpura',                          "red/purple skin spots; 'blood spots'",
    'Radiculopathy',                    'pinched nerve',
    'Ageusia',                          'loss of taste',
    'Erythema chronicum migrans',       'expanding rash early in lyme disease',
    'Photodermatitis',                  'allergic rash that reqs light',
)
```

```{r declare_helper_functions}
expand_state_name = function(state) {
  state_name = POSTAL_TO_STATE[[str_to_upper(state)]]
  return(state_name)
}

load_state_data = function(state) {
  if (state %in% names(cache_data_list)) return (cache_data_list[[state]])
  # Check whether there is a cached version
  state_fname = sprintf('cache/%s.csv', state)
  # if there isn't, then download
  if (!file.exists(state_fname)) {
    state_name = expand_state_name(state)
    message(sprintf('Downloading data for %s...', state_name))
    state_name_underscore = str_replace_all(state_name, ' ', '_')
    STATE_DAILY_URL = str_replace_all(BASE_DAILY_URL,
                                   fixed('{state}'), state_name)
    STATE_DAILY_URL = str_replace_all(STATE_DAILY_URL,
                                   fixed('{state_underscore}'),
                                   state_name_underscore)
    STATE_DAILY_URL = str_replace_all(STATE_DAILY_URL,
                                   fixed(' '),
                                   '%20')
    download.file(STATE_DAILY_URL, state_fname)
  }
  single_state = readr::read_csv(state_fname)
  cache_data_list[[state]] <<- single_state
  return (single_state)
}


pull_data_state = function(state, symptom, geo.selector="county") {
  single_state = load_state_data(state)
  
  if (geo.selector == 'state') {
    single_state_state = single_state[is.na(single_state$sub_region_2_code),]
    selected_symptom = paste0('symptom:', symptom)
    single_state_symptom = single_state_state[,c('sub_region_2_code',
                                                    'date',
                                                    selected_symptom)]
    # Shape into what we want
    colnames(single_state_symptom) = c('geo_value', 'time_value', 'value')
    
    # # Remove rows with missing values.
    # single_state_symptom = single_state_symptom %>% filter (
    #     !is.na(value),
    #   )
    single_state_symptom = single_state_symptom %>% transmute (
        geo_value = state,
        signal = symptom,
        time_value = time_value,
        direction = NA,
        issue = lubridate::today(),
        lag = issue - time_value,
        value = value,
        stderr = NA,
        sample_size = NA,
        data_source = 'google_symptoms',
      )
  } else if (geo.selector == 'county') {
    single_state_counties = single_state[!is.na(single_state$sub_region_2_code),]
    selected_symptom = paste0('symptom:', symptom)
    single_state_symptom = single_state_counties[,c('sub_region_2_code',
                                                    'date',
                                                    selected_symptom)]
    # Shape into what we want
    colnames(single_state_symptom) = c('geo_value', 'time_value', 'value')
    single_state_symptom = single_state_symptom %>% filter (
        !is.na(value),
      )
    single_state_symptom = single_state_symptom %>% transmute (
        geo_value = sprintf('%05d', as.numeric(geo_value)),
        signal = symptom,
        time_value = time_value,
        direction = NA,
        issue = lubridate::today(),
        lag = issue - time_value,
        value = value,
        stderr = NA,
        sample_size = NA,
        data_source = 'google_symptoms',
      )
  }
  
  return(single_state_symptom)
}
```


```{r read_google_symptoms_data, message=FALSE, warnings=FALSE, eval=FALSE}
if (file.exists('symptom_df.RDS')) {
  symptom_df = readRDS('symptom_df.RDS')
  symptom_names = unique(symptom_df$signal)
} else {
  dir.create('./cache/')
  
  # Read in a single state to get the set of symptoms reported.
  sample.data = load_state_data(states[1])
  symptom_cols = colnames(sample.data)[
                    str_detect(colnames(sample.data), 'symptom:')]
  
  # List of cleaned symptom names. Most start with a capital letter.
  symptom_names = str_replace(symptom_cols, fixed('symptom:'), '')

  # Make object to store symptom-by-symptom data.
  symptom_df_list = vector('list', length(symptom_names))
  names(symptom_df_list) = symptom_names

  # For every symptom, save all states of data.
  for (symptom in symptom_names) {
    print(symptom)
    cat(symptom, '...\n')
    states_list = vector('list', length(states))
    for (idx in 1:length(states)) {
      state = states[idx]
      states_list[[idx]] = pull_data_state(state, symptom)
    }
    symptom_df_list[[symptom]] = bind_rows(states_list)
  }
  
  # Combine all symptoms into a single dataframe and save to disk.
  symptom_df = bind_rows(symptom_df_list)
  saveRDS(symptom_df, 'symptom_df.RDS')
}
```


```{r read_anosmia_ageusia_google_symptoms_data, message=FALSE, warnings=FALSE}
if (file.exists('anosmia_ageusia_df.RDS')) {
  symptom_df = readRDS('anosmia_ageusia_df.RDS')
  symptom_names = unique(symptom_df$signal)
} else {
  dir.create('./cache/')

  # List of cleaned symptom names we're interested in.
  symptom_names = c("Anosmia", "Ageusia")

  # Make object to store symptom-by-symptom data.
  symptom_df_list = vector('list', length(symptom_names))
  names(symptom_df_list) = symptom_names

  # For every symptom, save all states of data.
  for (symptom in symptom_names) {
    print(symptom)
    cat(symptom, '...\n')
    states_list = vector('list', length(states))
    for (idx in 1:length(states)) {
      state = states[idx]
      states_list[[idx]] = pull_data_state(state, symptom, "state")
    }
    symptom_df_list[[symptom]] = bind_rows(states_list)
  }
  
  # Combine all symptoms into a single dataframe and save to disk.
  symptom_df = bind_rows(symptom_df_list)
  saveRDS(symptom_df, 'anosmia_ageusia_df.RDS')
}

rm(POSTAL_TO_STATE, BASE_DAILY_URL, states, signal_description_df, cache_data_list)
```

Anosmia and ageusia are strongly correlated, but quite unusual (~0.5 scaled search popularity compared to the most popular health related search, defined as 100). Searches on these topics were high in late March (the beginning of the nation-wide awareness of COVID) and in late June to July, before dying down again in August. Search popularity in September is only slightly more than baseline (January and February 2020).

```{r plot_anosmia_ageusia_data, message=FALSE, warnings=FALSE}

state_subset = unique(symptom_df$geo_value)
state_subset = state_subset[1:9]

plt = (ggplot(symptom_df[symptom_df$geo_value %in% state_subset, ])
       + geom_line(aes(x=time_value,
                       y=value,
                       group=signal,
                       color=signal),
                   size=0.2)
       + ggtitle(paste('Anosmia + ageusia search popularity in a subset of states'))
       + facet_wrap(.~ geo_value)
       )
plt

```

Google Health Trends (GHT) and Google Symptoms are only directly comparable at the state level, since GS can't be aggregated or divided due to the GS scaling process works (GS values are a scaled unitless version of per-capita number of searches on a given health topic).

```{r download_ght_indicator, echo = FALSE, message=FALSE, warnings=FALSE, cache=TRUE}
start_day = "2020-02-01"
end_day = "2020-09-19"
geo_type = "state"

raw_ght = covidcast_signal(data_source = "ght",
                   signal = "raw_search",
                   start_day = start_day, end_day = end_day,
                   geo_type = geo_type)

smoothed_ght = covidcast_signal(data_source = "ght",
                   signal = "smoothed_search",
                   start_day = start_day, end_day = end_day,
                   geo_type = geo_type)

rm(start_day, end_day, geo_type)
```


```{r merge_ght_symptoms_data}
sum_NA = function(value) {
  if (all(is.na(value))) {
    return (NA)
  } else {
    return(sum(value, na.rm = TRUE))
  }
} 

# Zero-filled column assumes missing values correspond to 0 (search term not used at all or used very little, such that data was removed due to privacy concerns).
sum_anosmia_ageusia = symptom_df %>%
  group_by(geo_value, time_value) %>%
  summarise(value = sum_NA(value),
            value_0_fill = sum(value, na.rm = TRUE))

# Join together the combination Google Symptoms indicator (Anosmia + Ageusia), raw and zero-filled, with the raw and smoothed GHT indicators.
ght_gs_df = full_join(
  full_join(sum_anosmia_ageusia %>%
              rename(raw_gs_anosmia_ageusia=value,
                     raw_gs_anosmia_ageusia_0_fill=value_0_fill), 
            raw_ght %>%
              select(geo_value, time_value, value) %>% 
              rename(raw_ght=value), 
            by=c("geo_value", "time_value")),
  smoothed_ght %>%
    select(geo_value, time_value, value) %>% 
    rename(smoothed_ght=value), 
  by=c("geo_value", "time_value")
)

rm(sum_NA, expand_state_name, load_state_data, pull_data_state, raw_ght, smoothed_ght, sum_anosmia_ageusia)
```


After scaling the GS A+A indicator, we can see that the general shape of GS A+A and GHT is similar. Many states exhibit an initial increase in late March in both indicators.However, the July "bump" seen in GS A+A is barely visible in GHT. GS A+A is smoother than both the raw and smoothed GHT indicator, which is smoother for large-population areas. GS A+A is approximately equally smooth for small and large-population states (in the subset shown, consider California and Florida vs others).

```{r plot_gs_div100_and_ght, message=FALSE, warnings=FALSE}
ght_div100_gs_df_long = ght_gs_df %>%
  mutate(smoothed_ght_div100=smoothed_ght / 100) %>%
  select(-smoothed_ght, -raw_gs_anosmia_ageusia_0_fill, -raw_ght) %>%
  tidyr::gather(signal, value, -time_value, -geo_value)

plt = (ggplot(ght_div100_gs_df_long[ght_div100_gs_df_long$geo_value %in% state_subset, ])
       + geom_line(aes(x=time_value,
                       y=value,
                       group=signal,
                       color=signal),
                   size=0.2)
       + ggtitle(paste('GHT % 100 and Google Symptoms A+A in a subset of states'))
       + facet_wrap(.~ geo_value)
       )
plt

```

As expected, there is clearly a positive relationship between GS A+A and GHT -- the relationship is stronger using smoothed GHT than raw.

```{r plot_gs_vs_ght_all_states, message=FALSE, warnings=FALSE}
plt = (ggplot(ght_gs_df)
       + geom_point(aes(x=smoothed_ght,
                       y=raw_gs_anosmia_ageusia,
                       color=time_value),
                   size=0.6)
       + ggtitle(paste('GS A+A vs smoothed GHT in all states'))
       )
plt
```

Unexpectedly, zeroes in GS A+A, many representing missing and/or low-count data, correspond to very high GHT values. This is concerning given that we expect missing GS observations to occur when sample size is small and search term is rare, causing data to be redacted for privacy reasons.

```{r plot_gs_0fill_vs_ght_all_states, message=FALSE, warnings=FALSE}
plt = (ggplot(ght_gs_df)
       + geom_point(aes(x=smoothed_ght,
                       y=raw_gs_anosmia_ageusia_0_fill,
                       color=time_value),
                   size=0.6)
       + ggtitle(paste('GS A+A (zero-filled) vs smoothed GHT in all states'))
       )
plt
```

Missing values sometimes correspond to large values in raw GHT as well, so the smoothing process is not the culprit. 

```{r plot_gs_0fill_vs_raw_ght_all_states, message=FALSE, warnings=FALSE}
plt = (ggplot(ght_gs_df)
       + geom_point(aes(x=raw_ght,
                       y=raw_gs_anosmia_ageusia_0_fill,
                       color=time_value),
                   size=0.6)
       + ggtitle(paste('GS A+A (zero-filled) vs raw GHT in all states'))
       )
plt
```

The shape and correlation of GS A+A vs GHT varies by state.

```{r plot_gs_vs_ght, message=FALSE, warnings=FALSE}
plt = (ggplot(ght_gs_df[ght_gs_df$geo_value %in% state_subset, ])
       + geom_point(aes(x=smoothed_ght,
                       y=raw_gs_anosmia_ageusia,
                       group=geo_value,
                       color=time_value),
                   size=0.4)
       + ggtitle(paste('GS A+A vs smoothed GHT in a subset of states'))
       + facet_wrap(.~ geo_value)
       )
plt
```

```{r corr_gs_vs_ght_by_state, message=FALSE, warnings=FALSE}
corr_by_state = ght_gs_df %>%
  group_by(geo_value) %>%
  summarise(corr=cor(raw_gs_anosmia_ageusia, smoothed_ght, use="na.or.complete", method="spearman")) %>% 
  arrange(desc(corr))

corr_by_state
```


Correlation between GS A+A and GHT varies widely by state (over all time).

```{r plot_gs_vs_ght_corr, message=FALSE, warnings=FALSE}
plt = (ggplot(corr_by_state,
              aes(x=1,
                  y=corr))
       + geom_violin(trim=TRUE)
       + geom_boxplot(width=0.1)
       + xlim(0, 2)
       + ylim(0, 1)
       + theme(axis.title.x=element_blank(),
               axis.text.x=element_blank(),
               axis.ticks.x=element_blank())
       + ggtitle(paste('Distribution of by-state correlations of GS A+A vs smoothed GHT'))
)
plt
```

```{r plot_gs_vs_ght_corr_state_labels, message=FALSE, warnings=FALSE}
plt = (ggplot(corr_by_state,
              aes(x=1,
                  y=corr,
                  label=toupper(geo_value)))
       + geom_violin(trim=TRUE)
       # + geom_dotplot(binaxis='y', stackdir='center', dotsize=0.4)
       + geom_jitter(position=position_jitter(0.05))
       + geom_text(check_overlap = TRUE, nudge_x = 0.2, size=2.5)
       + xlim(0, 2)
       + ylim(0, 1)
       + theme(axis.title.x=element_blank(),
               axis.text.x=element_blank(),
               axis.ticks.x=element_blank())
       + ggtitle(paste('Distribution of by-state correlations of GS A+A vs smoothed GHT'))
)
plt

rm(corr_by_state, ght_gs_x100_df_long)
```



```{r corr_gs_vs_ght_by_time, message=FALSE, warnings=FALSE}
corr_by_time = ght_gs_df %>%
  group_by(time_value) %>%
  summarise(corr=cor(raw_gs_anosmia_ageusia, smoothed_ght, use="na.or.complete", method="spearman"))

avg_signal_by_time = ght_gs_df %>% 
  group_by(time_value) %>%
  summarise(mean_ght_div100=mean(smoothed_ght, na.rm=TRUE) / 100,
            mean_gs_aa=mean(raw_gs_anosmia_ageusia, na.rm=TRUE))

corr_mean_signal = full_join(corr_by_time, avg_signal_by_time, by="time_value") %>% 
  tidyr::gather(signal, value, -time_value)

rm(corr_by_time, avg_signal_by_time)

plt = (ggplot(corr_mean_signal)
       + geom_line(aes(x=time_value,
                       y=value,
                       color=signal),
                   size=0.2)
       + ggtitle(paste('Correlation between GHT / 100 and Google Symptoms A+A', 
                       'in all states'))
       )
plt
```